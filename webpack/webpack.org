#+Title: webpack
#+Subtitle: anotacoes
#+PROPERTY: HEADER-ARGS :dir /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos

* Preparando nosso ambiente pro nosso desenvolvimento    
** configurando proxy (se for necessario)
  
   #+NAME: npm config list                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      npm config list
   #+END_SRC

   #+RESULTS: npm config list
   #+begin_example

   [wagner@localhost webpack]$ ; cli configs
   metrics-registry = "https://registry.npmjs.org/"
   scope = ""
   user-agent = "npm/6.5.0 node/v10.16.0 linux x64"

   ; userconfig /home/wagner/.npmrc
   https-proxy = "http://cid2:cid2@192.168.0.2:3128/"
   proxy = "http://cid2:cid2@192.168.0.2:3128/"

   ; node bin location = /usr/bin/node
   ; cwd = /home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack
   ; HOME = /home/wagner
   ; "npm config ls -l" to show all defaults.
   #+end_example
  

   #+NAME: npm config unset proxy
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      npm config delete proxy
      npm config delete https-proxy
      npm config list
   #+END_SRC

   #+RESULTS: npm config unset proxy
   #+begin_example

   [wagner@localhost webpack]$ [wagner@localhost webpack]$ ; cli configs
   metrics-registry = "https://registry.npmjs.org/"
   scope = ""
   user-agent = "npm/6.5.0 node/v10.16.0 linux x64"

   ; node bin location = /usr/bin/node
   ; cwd = /home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack
   ; HOME = /home/wagner
   ; "npm config ls -l" to show all defaults.
   #+end_example


* Criando um projeto e Instalando webpack[fn:webpackInstall]
  A instalacao do webpack pode ser realizada especificamente para o
  seu projeto. Portanto, primeiro crie uma pasta para o seu projeto,
  de um npm init e depois sim vc instala o webpack para o seu projeto.

  Entao o processo fica assim...

  Primeiro criamos o projeto
  
#+NAME: webpackinstallation
#+BEGIN_SRC shell :session s1 :results output :exports code
  mkdir -p  ./projetos/gettingstarting
  cd ./projetos/gettingstarting
  npm init
#+END_SRC

salvamos o caminho do diretorio do projeto na variavel projDir pra
facilitar a gente entrar no diretorio toda vez que tivermos que
digitar um comando no projeto.

#+NAME:export projdir
#+BEGIN_SRC shell :session s1 :results output :exports both
  export projDir=$(pwd)/projetos/gettingstarting
  echo $projDir
#+END_SRC

#+RESULTS: export projdir
: 
: /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting



#+NAME:webpackinstallation
#+BEGIN_SRC shell :session s1 :results output :exports both
  cd $projDir 
  npm init -y
  npm install --save-dev webpack
  npm install --save-dev webpack-cli
#+END_SRC

#+RESULTS: webpackinstallation
#+begin_example

npm WARN deprecated chokidar@2.1.8: Chokidar 2 will break on node v14+. Upgrade to chokidar 3 with 15x less dependencies.
npm WARN deprecated fsevents@1.2.13: fsevents 1 will break on node v14+ and could be using insecure binaries. Upgrade to fsevents 2.
npm WARN notsup Unsupported engine for watchpack-chokidar2@2.0.0: wanted: {"node":"<8.10.0"} (current: {"node":"12.16.3","npm":"6.14.4"})
npm WARN notsup Not compatible with your version of node/npm: watchpack-chokidar2@2.0.0
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@~2.1.2 (node_modules/chokidar/node_modules/fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@2.1.3: wanted {"os":"darwin","arch":"any"} (current: {"os":"linux","arch":"x64"})
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@^1.2.7 (node_modules/watchpack-chokidar2/node_modules/chokidar/node_modules/fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.2.13: wanted {"os":"darwin","arch":"any"} (current: {"os":"linux","arch":"x64"})
npm WARN gettingstarting@1.0.0 No description
npm WARN gettingstarting@1.0.0 No repository field.

+ webpack@4.44.1
updated 1 package and audited 417 packages in 21.178s

1 package is looking for funding
  run `npm fund` for details

found 251 vulnerabilities (188 low, 63 high)
  run `npm audit fix` to fix them, or `npm audit` for details
npm WARN gettingstarting@1.0.0 No description
npm WARN gettingstarting@1.0.0 No repository field.
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@2.1.3 (node_modules/fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@2.1.3: wanted {"os":"darwin","arch":"any"} (current: {"os":"linux","arch":"x64"})
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.2.13 (node_modules/watchpack-chokidar2/node_modules/fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.2.13: wanted {"os":"darwin","arch":"any"} (current: {"os":"linux","arch":"x64"})

+ webpack-cli@3.3.12
added 7 packages from 13 contributors, removed 23 packages, updated 16 packages and audited 401 packages in 16.7s

5 packages are looking for funding
  run `npm fund` for details

found 251 vulnerabilities (188 low, 63 high)
  run `npm audit fix` to fix them, or `npm audit` for details
#+end_example


* Primeiro build do projeto com webpack

  o comando pra rodar o webpack das seguintes formas possiveis:

  ./node_modules/.bin/webpack --config webpack.config.js

  ou 

  npx

  ou ainda se vc instalar o webpack globalmente na sua maquina, ai da
  pra rodar direto

  npm install --global webpack

  
  ou npx webpack --config webpack.config.js

  
  Mas a gente nao vai rodar isso na mao toda hora nao...

  a gente vai colocar esse comando na propriedade script do arquivo
  package json, conforme abaixo...


  
#+NAME:
#+BEGIN_SRC js :session s1 :results output :exports code
    "scripts": {
        "test": "echo \"Error: no test specified\" && exit 1",
        "build": "webpack --config webpack.config.js"
    },
  
#+END_SRC

apos fazer isso pra rodar esse comando e buidar nosso projeto a gente
pode fazer somente o seguinte...


npm run build

vamos ver se funciona...
nao esquece de entrar na pasta do seu projeto, nao funciona em
qualquer pasta...

#+NAME: rodando npm run build
#+BEGIN_SRC shell :session s1 :results output :exports both
npm run build
#+END_SRC

Essa e a saida... radar rodou mas ta faltando o webpack.config.js

#+NAME: npm run build sem o webpack.config.js
#+begin_example
gettingstarted@1.0.0 build /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting
webpack --config webpack.config.js

/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/cli.js:93
				throw err;
				^

Error: Cannot find module '/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/webpack.config.js'
Require stack:
- /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/utils/convert-argv.js
- /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/cli.js
- /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack/bin/webpack.js
    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:957:15)
    at Function.Module._load (internal/modules/cjs/loader.js:840:27)
    at Module.require (internal/modules/cjs/loader.js:1019:19)
    at require (/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/v8-compile-cache/v8-compile-cache.js:161:20)
    at WEBPACK_OPTIONS (/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/utils/convert-argv.js:114:13)
    at requireConfig (/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/utils/convert-argv.js:116:6)
    at /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/utils/convert-argv.js:123:17
)
    at module.exports (/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/utils/convert-argv.js:121:15)
    at /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/cli.js:71:45
    at Object.parse (/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/yargs/yargs.js:576:18)
    at /run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/cli.js:49:8
(/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/cli.js:366:3)
    at Module._compile (internal/modules/cjs/loader.js:1133:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1153:10)
    at Module.load (internal/modules/cjs/loader.js:977:32)
    at Function.Module._load (internal/modules/cjs/loader.js:877:14)
    at Module.require (internal/modules/cjs/loader.js:1019:19)
    at require (internal/modules/cjs/helpers.js:77:18)
(/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack/bin/webpack.js:156:2)
    at Module._compile (internal/modules/cjs/loader.js:1133:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1153:10)
    at Module.load (internal/modules/cjs/loader.js:977:32)
    at Function.Module._load (internal/modules/cjs/loader.js:877:14)
    at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:74:12)
    at internal/main/run_main_module.js:18:47 {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/utils/convert-argv.js',
    '/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack-cli/bin/cli.js',
    '/run/media/wagner/hdext1Twgn/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/webpack/projetos/gettingstarting/node_modules/webpack/bin/webpack.js'
  ]
}
npm ERR! code ELIFECYCLE
npm ERR! errno 1
npm ERR! gettingstarted@1.0.0 build: `webpack --config webpack.config.js`
npm ERR! Exit status 1
npm ERR! 
npm ERR! Failed at the gettingstarted@1.0.0 build script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     /home/wagner/.npm/_logs/2020-08-29T13_50_21_676Z-debug.log
#+end_example


* Scaffolding (Inicializando) um projeto bem generico[fn:wpSiteScaffolding]
  
instale o webpack-cli


#+NAME:instale o webpack-cli
#+BEGIN_SRC shell :session s1 :results output :exports both
npm 
#+END_SRC


#+NAME:gerandoscaffolding
#+BEGIN_SRC shell :session s1 :results output :exports both
   npx webpack-cli init .
#+END_SRC

#+RESULTS: gerandoscaffolding
: bash: webpack-cli: comando nÃ£o encontrado


* Conceitos Importantes para esta momento
** Webpack mode
   O build vai se comportar diferente entre o modo production e
   development
   
** 

* Conceitos Importantes para esta momento
** Source Maps
  devtool: 'source-map'
  Como você iria debugar um código depois de criado o bundle? Depois
  de criado o bundle o código está unido, comprimido etc..
  A resposta são os source maps, que mapeia o código comprimido pro
  código que você escreveu.
  O Firefox sabe usar source maps por padrão, no chrome tem que
  ativar.
  Pra indicar pro navegador que o seu código está acompanhado de
  source map, coloque um comentário, como esse abaixo, no final do seu código
  otimizado.[fn:sourcemaps1]

  //# sourceMappingURL=/path/to/script.js.map

  Também dá pra informar que o seu código tem um source map via
  protocolo HTTP enviando na sua resposta que envia o seu javascript a
  seguinte linha de cabecalho:
  
  X-SourceMap: /path/to/script.js.map

  Ainda sobre source maps, tem uma discussão interessante porque pode
  ser influenciada pelo modo "production" ou "development" do webpack.[fn:sourcemaps3]

  A artigo de blog de Robat Williams esclarece mais sobre as
  configurações possíveis para criação dos sourcemaps [fn:sourcemaps2]
  
  No *modo development*, queremos:
  Rebuilds Rápidos
  
  - Modo none: 
    Não colocar no seu webpack.config.js devtool significa não usar sourcemaps.
  - Modo eval: 
    Esse modo só separa os arquivos, nomeia eles, e os
    organiza de acordo com a estrutura de pastas do seu projeto.
  - Modo cheap-eval-source-map
    Aquele código que o webpack gera é removido
    Passa a ser possível observar o output dos seus loaders e
    transpilers
    Também é bastantes rápido o build e rebuilds
  - cheap-module-eval-source-map
    Agora o source map traz o seu codigo fonte
    O build não é tão rápido mas os rebuilds são
  - eval-source-map
    São adicionados ao seu código fonte mapealment em nível de coluna
    (column-level mappings) o que permite vc fazer uso de breakpoints
    em nível de instruções do seu código.
    É a melhor opçao com builds lentos mas rebuilds rápidos. O debug,
    neste caso, é ótimo.

  No *modo production* queremos:
  
  Não disponibilizar o código fonte - confidencialidade.
  Não disponibilizar downloads desenecessários - performance.
  Stacktraces úteis - manutenibilidade

  - Modo none: 
    Não usar sourcemaps implica nada de stacktraces
  - Modo source-map: 
    Essa opção gera um arquivo separado com mapeamento completo ao seu
    código fonte original e no código compilado é colocado aquele
    comentário que diz pro nevegador o local onde ele carrega do
    arquivo de source map.
    Tem que restringir o acesso a esse arquivo pra proteger o seu código.
  - Modo hidden-source-map
    Gera tudo como no source-map mas não inclui o comentário que
    permite o navegador carregar o source map.
  - nosources-source-map
    Neste caso vc consegue um stacktrace interessante do seu usuário
    em caso de algum problema, mas o custo disso é que a estrutura de
    diretório dos seu código fica exposta bem como o nome do seus
    módulos.
    O nome dos métodos e o seu código fonte em sí não são
    disponibilizados e também não são utilizados no stacktrace o que
    empobrece um pouco as qtde de informações do seu stacktrace.




* refs
[fn:webpack1] https://webpack.js.org/guides/getting-started/
[fn:webpack2] https://webpack.js.org/concepts/

[fn:sourcemaps1] https://blog.teamtreehouse.com/introduction-source-maps
[fn:sourcemaps2]https://blog.scottlogic.com/2017/11/01/webpack-source-map-options-quick-guide.html
[fn:sourcemaps3] https://stackoverflow.com/questions/48986641/webpack-4-sourcemaps
[fn:webpackInstall] https://webpack.js.org/guides/installation/#local-installation
[fn:wpSiteScaffolding] https://webpack.js.org/guides/scaffolding/
